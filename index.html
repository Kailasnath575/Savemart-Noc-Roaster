<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shift Roster (HTML)</title>
<style>
  :root{
    --bg:#f4f7fb;
    --panel:#ffffff;
    --muted:#556;
    --accent:#0b69ff;
    --m:#d8f2d8;
    --a:#fff9c4;
    --n:#e7e6ff;
    --o:#ffd6d6;
    --table-border:#d7dee6;
  }

  body{
    margin:0;
    font-family: Inter, Arial, Helvetica, sans-serif;
    background:var(--bg);
    color:#072235;
    padding:18px;
  }

  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  h1{font-size:18px;margin:0}

  .panel{
    background:var(--panel);
    padding:12px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(7,18,29,0.06);
    margin-bottom:12px;
  }

  textarea,input,button,select{font-family:inherit}

  textarea{
    min-height:120px;
    width:520px;
    max-width:100%;
    padding:8px;
    border-radius:7px;
    border:1px solid #dfe7ef;
  }

  input[type="month"]{
    padding:8px;
    border-radius:6px;
    border:1px solid #dfe7ef;
  }

  .btn{
    background:var(--accent);
    color:#fff;
    border:0;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
  }

  .btn.alt{background:#6b7280}
  .small{font-size:13px;color:var(--muted)}

  /* TABLE */
  .roster-table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    table-layout:fixed;
    border:1px solid var(--table-border);
  }

  .roster-table thead th{
    background:#0b69ff;
    color:#fff;
    padding:10px;
    border-right:1px solid rgba(255,255,255,0.08);
    font-weight:600;
    font-size:13px;
  }

  .roster-table thead th:first-child{
    background:#f0f6fb;
    color:#072235;
  }

  .roster-table tbody td{
    padding:8px 10px;
    border-right:1px solid #eef3f7;
    border-bottom:1px solid #eef3f7;
    font-size:13px;
    vertical-align:top;
    word-wrap:break-word;
  }

  .date-cell{
    width:110px;
    background:#f6fbff;
    font-weight:700;
    text-align:left;
    padding-left:12px;
  }

  .col-m{background:var(--m)}
  .col-a{background:var(--a)}
  .col-n{background:var(--n)}
  .col-o{background:var(--o)}

  .names-list{display:flex;flex-wrap:wrap;gap:6px}

  .pill{
    background:rgba(0,0,0,0.04);
    padding:4px 8px;
    border-radius:999px;
    font-size:12px;
  }

  /* SUMMARY TABLE */
  .summary-table{
    width:100%;
    border-collapse:collapse;
    margin-top:18px;
    border:1px solid #d0d0d0;
  }

  .summary-table th{
    background:#e9eef5;
    padding:8px 10px;
    border:1px solid #d0d0d0;
    font-size:13px;
    text-align:left;
  }

  .summary-table td{
    padding:7px 10px;
    border:1px solid #e0e0e0;
    font-size:13px;
  }

  @media (max-width:900px){
    textarea{width:100%}
    .roster-table thead th{font-size:12px;padding:8px}
    .roster-table tbody td{font-size:12px;padding:6px}
  }

  /* ======== MODAL ======== */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.4);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1000;
  }

  .modal{
    background:#ffffff;
    border-radius:10px;
    box-shadow:0 10px 30px rgba(7,18,29,0.25);
    max-width:900px;
    width:100%;
    max-height:80vh;
    padding:16px 18px;
    overflow:auto;
  }

  .modal h2{
    margin:0 0 6px;
    font-size:16px;
  }

  .history-rows{
    border:1px solid #e2e8f0;
    border-radius:8px;
    padding:8px;
    max-height:55vh;
    overflow:auto;
    background:#f9fbff;
  }

  .history-row{
    display:flex;
    align-items:center;
    gap:6px;
    margin-bottom:6px;
    flex-wrap:wrap;
  }

  .history-name{
    min-width:110px;
    font-size:13px;
    font-weight:600;
  }

  .history-select{
    width:52px;
    font-size:12px;
    padding:3px;
    border-radius:4px;
    border:1px solid #cbd5e1;
  }

  .modal-actions{
    margin-top:10px;
    display:flex;
    justify-content:flex-end;
    gap:8px;
  }

  /* ======== LOADER ======== */
  #loadingOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    backdrop-filter:blur(3px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
  }

  .loader-box{
    text-align:center;
    color:white;
  }

  .spinner{
    border:4px solid rgba(255,255,255,0.3);
    border-top:4px solid #ffffff;
    border-radius:50%;
    width:45px;
    height:45px;
    margin:auto;
    animation:spin 0.9s linear infinite;
  }

  @keyframes spin{
    from{transform:rotate(0deg);}
    to{transform:rotate(360deg);}
  }
</style>
</head>
<body>

<!-- ===== LOADING OVERLAY ===== -->
<div id="loadingOverlay">
  <div class="loader-box">
    <div class="spinner"></div>
    <div style="margin-top:12px;font-size:15px;">Generating roster...</div>
  </div>
</div>

<div class="wrap">
  <header>
    <h1>Shift Roster</h1>
  </header>

  <div class="panel">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <label><strong>Employee names</strong></label><br>
        <textarea id="names"></textarea>

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="sampleBtn" class="btn alt">Fill sample</button>
          <button id="clearBtn" class="btn alt">Clear</button>
          <button id="resetStateBtn" class="btn alt">Reset history</button>
        </div>
      </div>

      <div style="width:260px">
        <label><strong>Month</strong></label>
        <input id="month" type="month" style="width:100%" />
        <br><br>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="generateBtn" class="btn">Generate Roster</button>
          <button id="exportBtn" class="btn alt">Export CSV</button>
        </div>

        <div id="stateInfo" class="small" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

  <div id="output" class="panel">
    <div class="small" style="color:var(--muted)">No roster yet — paste names and click Generate Roster.</div>
  </div>
</div>

<!-- ===== MODAL ===== -->
<div id="historyModal" class="modal-backdrop">
  <div class="modal">
    <h2>Set Last 10 Days Shifts</h2>
    <div class="small">
      Enter last 10 days (M/A/N/O). Only last 7 used.
    </div>

    <div id="historyModalBody" class="history-rows"></div>

    <div class="modal-actions">
      <button id="historyModalCancel" class="btn alt">Cancel</button>
      <button id="historyModalSave" class="btn">Save & Continue</button>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function(){

  const namesEl   = document.getElementById('names');
  const monthEl   = document.getElementById('month');
  const outEl     = document.getElementById('output');
  const sampleBtn = document.getElementById('sampleBtn');
  const clearBtn  = document.getElementById('clearBtn');
  const resetStateBtn = document.getElementById('resetStateBtn');
  const generateBtn = document.getElementById('generateBtn');
  const exportBtn   = document.getElementById('exportBtn');
  const stateInfoEl = document.getElementById('stateInfo');

  const historyModal       = document.getElementById('historyModal');
  const historyModalBody   = document.getElementById('historyModalBody');
  const historyModalSave   = document.getElementById('historyModalSave');
  const historyModalCancel = document.getElementById('historyModalCancel');

  /* ===== Loader ===== */
  function showLoader(){
    document.getElementById('loadingOverlay').style.display = 'flex';
  }
  function hideLoader(){
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  /* Default month = current */
  (function(){
    const now = new Date();
    const mm = String(now.getMonth()+1).padStart(2,'0');
    monthEl.value = `${now.getFullYear()}-${mm}`;
    updateStateInfo();
  })();

  function parseNames(text){
    if(!text) return [];
    return text.split(/[\r\n,]+/).map(s=>s.trim()).filter(Boolean);
  }

  function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }

  const cycle = ['M','A','N']; // rotation
  const WORK_DAYS = 5;

  let lastState = null;

  function getMonthKey(year, month){
    const mm = String(month).padStart(2,'0');
    return `${year}-${mm}`;
  }

  function getPrevMonth(year, month){
    let py = year, pm = month - 1;
    if(pm === 0){ pm = 12; py = year - 1; }
    return {year:py, month:pm};
  }

  function loadPrevEmployeeState(year, month){
    try{
      const prev = getPrevMonth(year, month);
      const prevKey = getMonthKey(prev.year, prev.month);
      const raw = localStorage.getItem('rosterState_' + prevKey);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.employees) return null;
      return obj.employees;
    }catch(e){ return null; }
  }

  function saveEmployeeState(year, month, endState){
    try{
      const key = 'rosterState_' + getMonthKey(year, month);
      const payload = {employees:endState, savedAt:new Date().toISOString()};
      localStorage.setItem(key, JSON.stringify(payload));
    }catch(e){}
  }

  function updateStateInfo(){
    try{
      const mv = monthEl.value;
      if(!mv){ stateInfoEl.textContent=''; return; }

      const [yStr,mStr] = mv.split('-');
      const year = Number(yStr), month = Number(mStr);
      const prev = getPrevMonth(year, month);

      const prevKey = getMonthKey(prev.year, prev.month);
      const hasPrev = !!localStorage.getItem('rosterState_' + prevKey);

      stateInfoEl.textContent = hasPrev
        ? `Previous month found (${prevKey}) — continuing rotation.`
        : `No previous month state found — starting fresh.`;
    }catch{}
  }

  monthEl.addEventListener('change', updateStateInfo);

  function normDay(d){ d = d % 7; return d < 0 ? d + 7 : d; }
  function normBlock(b){ b = b % 3; return b < 0 ? b + 3 : b; }

  function summarizeOffWeekdays(list){
    if(!list.length) return [];
    const freq = {};
    list.forEach(w => freq[w] = (freq[w]||0) + 1);
    const items = Object.entries(freq)
      .map(([w,c]) => ({w:Number(w), c}))
      .sort((a,b)=> b.c - a.c || a.w - b.w);
    return items.slice(0,2).map(x=>x.w);
  }

  function simulateOffWeekdays(blockIndex, dayInBlock, dates){
    const offW = [];
    let b = blockIndex;
    let dIn = dayInBlock;

    for(let i=0; i<dates.length; i++){
      if(dIn >= WORK_DAYS) offW.push(dates[i].getDay());
      dIn++;
      if(dIn >= 7){ dIn=0; b=(b+1)%3; }
    }
    return summarizeOffWeekdays(offW);
  }

  function sameWeekdayPair(a, b){
    if(!a||!b||a.length!==b.length) return false;
    return [...a].sort().join(',') === [...b].sort().join(',');
  }

  function chooseStartState(prevState, prevOffPair, dates, naturalBlock, naturalDay){
    if(!prevOffPair || prevOffPair.length!==2){
      return {blockIndex:naturalBlock, dayInBlock:naturalDay};
    }

    const candidates = [];
    const deltas = [0,1,-1,2,-2,3,-3];

    for(const d of deltas){
      const candDay = normDay(naturalDay + d);
      const offPair = simulateOffWeekdays(naturalBlock, candDay, dates);
      if(!sameWeekdayPair(offPair, prevOffPair)){
        candidates.push({blockIndex:naturalBlock, dayInBlock:candDay, cost:Math.abs(d)});
      }
    }

    if(!candidates.length) return {blockIndex:naturalBlock, dayInBlock:naturalDay};

    candidates.sort((a,b)=> a.cost - b.cost);
    return candidates[0];
  }

  /* ======== Roster Generator (with caps & continuation) ======== */
  function computeRoster(names, year, month){

    const total = daysInMonth(year, month-1);
    const dates = [];
    for(let d=1; d<=total; d++) dates.push(new Date(year, month-1, d));

    const dayBuckets = dates.map(()=>({M:[],A:[],N:[],O:[]}));
    const prevEmployees = loadPrevEmployeeState(year, month) || {};

    let nextBlockIndexForNew = 0;
    let nextDayInBlockForNew = 0;

    const startStates = {};
    const endState = {};

    names.forEach(name=>{
      let naturalBlock, naturalDay;
      const prev = prevEmployees[name];
      let prevOffPair = null;

      if(prev && typeof prev.blockIndex==="number"){
        naturalBlock = normBlock(prev.blockIndex);
        naturalDay   = normDay(prev.dayInBlock);
        if(prev.offWeekdays) prevOffPair = prev.offWeekdays.slice(0,2);
      }else{
        naturalBlock = nextBlockIndexForNew;
        naturalDay   = nextDayInBlockForNew;
        nextBlockIndexForNew = (nextBlockIndexForNew+1)%3;
        nextDayInBlockForNew = (nextDayInBlockForNew+1)%7;
      }

      startStates[name] = chooseStartState(prev, prevOffPair, dates, naturalBlock, naturalDay);
    });

    names.forEach(name=>{
      let {blockIndex, dayInBlock} = startStates[name];
      const offW = [], offDates = [];

      const SHIFT_CAP = { M:4, A:4, N:3 };

      for(let di=0; di<dates.length; di++){
        if(dayInBlock < WORK_DAYS){
          const assignedShift = cycle[blockIndex];
          let placed = false;
          let startIdx = cycle.indexOf(assignedShift);

          for(let k=0; k<cycle.length; k++){
            const s = cycle[(startIdx+k)%cycle.length];
            if(dayBuckets[di][s].length < SHIFT_CAP[s]){
              dayBuckets[di][s].push(name);
              placed = true;
              break;
            }
          }

          if(!placed){
            dayBuckets[di].O.push(name);
            offW.push(dates[di].getDay());
            offDates.push(dates[di].getDate());
          }

        }else{
          dayBuckets[di].O.push(name);
          offW.push(dates[di].getDay());
          offDates.push(dates[di].getDate());
        }

        dayInBlock++;
        if(dayInBlock >= 7){
          dayInBlock = 0;
          blockIndex = (blockIndex+1)%3;
        }
      }

      const offPair = summarizeOffWeekdays(offW);
      endState[name] = {blockIndex, dayInBlock, offWeekdays:offPair, offDates};
    });

    return {dates, dayBuckets, endState};
  }

  function weekdayName(i){
    return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][i];
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));
  }

  function renderCompact(state){
    const {dates, dayBuckets, endState} = state;
    if(!dates.length){
      outEl.innerHTML = '<div class="small" style="color:#556">No dates.</div>';
      return;
    }

    let html = `
      <table class="roster-table">
        <thead><tr>
          <th>Date</th><th>Morning</th><th>Afternoon</th><th>Night</th><th>Off</th>
        </tr></thead><tbody>
    `;

    for(let i=0;i<dates.length;i++){
      const d = dates[i], b = dayBuckets[i];

      const cell = (arr,cls)=>
        `<td class="${cls}"><div class="names-list">${
          arr.length ? arr.map(n=>`<div class="pill">${escapeHtml(n)}</div>`).join('')
                     : `<div class="pill" style="opacity:.4">—</div>`
        }</div></td>`;

      html += `
        <tr>
          <td class="date-cell">${d.toLocaleDateString(undefined,{weekday:'short'})}
            <strong style="margin-left:8px">${d.getDate()}</strong>
          </td>
          ${cell(b.M,'col-m')}
          ${cell(b.A,'col-a')}
          ${cell(b.N,'col-n')}
          ${cell(b.O,'col-o')}
        </tr>
      `;
    }

    html += `</tbody></table>`;

    if(endState){
      html += `<h3 style="margin-top:18px;font-size:16px;">Employee OFF Summary</h3>`;
      html += `<table class="summary-table"><thead>
          <tr><th>Employee</th><th>OFF Weekdays</th><th>OFF Dates</th></tr>
        </thead><tbody>`;

      const names = Object.keys(endState).sort();
      names.forEach(name=>{
        const info = endState[name];
        const offs = info.offWeekdays||[];
        const dts = info.offDates||[];

        const weekdayLabel = offs.length ? offs.sort().map(weekdayName).join(', ') : '—';
        const datesLabel = dts.length ? dts.sort((a,b)=>a-b).join(', ') : '—';

        html += `
          <tr>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(weekdayLabel)}</td>
            <td>${escapeHtml(datesLabel)}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
    }

    outEl.innerHTML = html;
  }

  /* ====== Generate (with loader) ====== */
  function generate(){
    const names = parseNames(namesEl.value);
    if(!names.length) return alert("Enter names");

    const monthVal = monthEl.value;
    if(!monthVal) return alert("Select month");

    const [yStr,mStr] = monthVal.split('-');
    const year = Number(yStr), month = Number(mStr);

    showLoader();

    setTimeout(()=>{
      const result = computeRoster(names, year, month);
      lastState = result;
      renderCompact(result);

      saveEmployeeState(year, month, result.endState);
      updateStateInfo();
      hideLoader();
    }, 400);
  }

  function exportCSV(){
    if(!lastState) return alert("Generate first");

    const {dates, dayBuckets} = lastState;
    const rows = [['Date','Morning','Afternoon','Night','Off']];

    for(let i=0;i<dates.length;i++){
      const d = dates[i], b = dayBuckets[i];
      rows.push([
        d.toISOString().slice(0,10),
        b.M.join(' | '),
        b.A.join(' | '),
        b.N.join(' | '),
        b.O.join(' | ')
      ]);
    }

    const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='roster.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  /* ===== Manual History Modal ===== */

  function openHistoryModal(names){
    if(!names.length) return alert("Enter names first");

    let html = '';
    names.forEach(name=>{
      const safe = escapeHtml(name);
      html += `<div class="history-row">
        <div class="history-name">${safe}</div>`;
      for(let i=0;i<10;i++){
        html += `<select class="history-select">
            <option></option>
            <option>M</option>
            <option>A</option>
            <option>N</option>
            <option>O</option>
        </select>`;
      }
      html += `</div>`;
    });

    historyModalBody.innerHTML = html;
    historyModal.style.display = 'flex';
  }

  function deriveStateFromCodes(codes){
    const seq = codes
      .map(c=>String(c).trim().toUpperCase())
      .filter(c=>['M','A','N','O'].includes(c));

    if(!seq.length) return null;

    const last7 = seq.slice(-7);
    const n = last7.length;
    const lastIdx = n-1;

    let trailingOff=0;
    for(let i=lastIdx; i>=0; i--){
      if(last7[i]==='O') trailingOff++;
      else break;
    }

    let blockIndex=0, dayInBlock=0;

    if(trailingOff>0){
      const workIdx = lastIdx - trailingOff;
      if(workIdx>=0 && last7[workIdx] !== 'O'){
        const ci = cycle.indexOf(last7[workIdx]);
        if(ci>=0) blockIndex=ci;
      }
      dayInBlock = trailingOff===1 ? 5 : 6;
    }else{
      const lastShift = last7[lastIdx];
      const ci = cycle.indexOf(lastShift);
      if(ci>=0) blockIndex=ci;

      let workStreak=0;
      for(let i=lastIdx; i>=0;i--){
        if(last7[i]==='O') break;
        workStreak++;
      }
      dayInBlock = workStreak-1;
      if(dayInBlock>=WORK_DAYS) dayInBlock=WORK_DAYS-1;
    }

    dayInBlock++;
    if(dayInBlock>=7){
      dayInBlock=0;
      blockIndex = (blockIndex+1)%3;
    }

    return {blockIndex, dayInBlock, offWeekdays:[]};
  }

  function handleHistorySave(){
    const mv = monthEl.value;
    if(!mv) return alert("Select month before saving");

    const [yStr,mStr] = mv.split('-');
    const year = Number(yStr), month = Number(mStr);

    const prev = getPrevMonth(year, month);
    const prevKey = getMonthKey(prev.year, prev.month);

    const employeesState = {};
    const rows = historyModalBody.querySelectorAll('.history-row');

    rows.forEach(row=>{
      const name = row.querySelector('.history-name').textContent.trim();
      const selects = row.querySelectorAll('.history-select');

      const codes=[];
      selects.forEach(sel=>{
        const v = sel.value.trim().toUpperCase();
        if(v) codes.push(v);
      });

      const st = deriveStateFromCodes(codes);
      if(st) employeesState[name] = st;
    });

    localStorage.setItem('rosterState_' + prevKey, JSON.stringify({
      employees:employeesState,
      savedAt:new Date().toISOString(),
      manual:true
    }));

    historyModal.style.display='none';
    updateStateInfo();
    alert(`History saved for previous month (${prevKey})`);
  }

  function closeHistoryModal(){
    historyModal.style.display='none';
  }

  /* Buttons */

  sampleBtn.addEventListener('click', ()=>{
    namesEl.value = [
      'Kailas','Rahul','Jeny','Anupama','Anugrah',
      'Devaganga','Deepak','Raoof','Bhavya','Ajay','Arjun','Jubin'
    ].join('\n');
  });

  clearBtn.addEventListener('click', ()=>{
    namesEl.value='';
    outEl.innerHTML = '<div class="small" style="color:var(--muted)">No roster yet.</div>';
    lastState=null;
  });

  resetStateBtn.addEventListener('click', ()=>{
    if(!confirm('This will clear all saved history. Continue?')) return;

    Object.keys(localStorage)
      .filter(k=>k.startsWith('rosterState_'))
      .forEach(k=>localStorage.removeItem(k));

    updateStateInfo();
    const names = parseNames(namesEl.value);
    openHistoryModal(names);
  });

  historyModalCancel.addEventListener('click', closeHistoryModal);
  historyModal.addEventListener('click', e=>{
    if(e.target===historyModal) closeHistoryModal();
  });

  historyModalSave.addEventListener('click', handleHistorySave);
  generateBtn.addEventListener('click', generate);
  exportBtn.addEventListener('click', exportCSV);

});
</script>
</body>
</html>

